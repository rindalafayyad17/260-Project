---
title: "WordClouds"
date: "11/16/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library(MASS)
library(tidyverse)
library(dplyr)
library(htmlwidgets)
library(ggthemes)
library(ggrepel)
library(gridExtra)
library(webshot)
# wages/salary dataset
wages <- read_csv("wages_norepeats.csv")
wages <- as_tibble(wages) %>%
    rename(city = City, occupation = Occupation, hourly = 'Hourly Wage', annual = 'Annual Wage')

# data cleaning
# need to remove wage values labeled as > 208,000
wages <- wages %>%
    mutate(annual  = recode(annual,
                            ">208000" = 'NA'
    )) %>%
    mutate(annual = str_remove(annual, ",")) %>% 
    mutate(annual = as.numeric(annual))

# cost of living data
cost <- read_csv("full_col_data.csv")

# will need to make the data wide
# create new variable which will be used to calculate monthly expenses and discretionary income
cost <- cost %>% 
    pivot_wider(names_from = metrics, values_from = price) %>% 
    # average meals per week out is 4 (16 monthly)! 
    mutate(expenses = 16 * as.numeric(`Meal, Inexpensive Restaurant`) + 
             as.numeric(`Apartment (1 bedroom) in City Centre`) + 
               as.numeric(`Basic (Electricity, Heating, Cooling, Water, Garbage) for 915 sq ft Apartment`) + 
               as.numeric(`Internet (60 Mbps or More, Unlimited Data, Cable/ADSL)`))
cost$AnnualExpenses=12*cost$expenses


# set the values which can be selected from the city and occupations inputs
cities <- sort(unique(wages$city))
occupations <- sort(unique(wages$occupation))

#select the mean annual salary by each city
mean_salary <- wages %>%
            filter(occupation == "All Occupations") %>%
            dplyr:::select(annual,city)
#select the annual expenses by each city
annual_expenses=cost %>%
            dplyr:::select(city, AnnualExpenses)

#merge the two dataframe
salary_expenses_byCity <- merge(mean_salary,annual_expenses,by="city")
names(salary_expenses_byCity)[2] <- "AnnualSalary"

#Saving the data frame as a csv
#write.csv(salary_expenses_byCity,"C:/Users/Rindala/Desktop/Harvard/FALL 2021/BST 260/260-Project\\salary_expenses_byCity.csv", row.names = FALSE)
```


## Word Cloud


```{r}
#install.packages("wordcloud")
library(wordcloud)
#install.packages("RColorBrewer")
library(RColorBrewer)
#install.packages("wordcloud2")
library(wordcloud2)
library(tm)

##create the overall wordcloud image of high-paying jobs in the 50 cities

#select out all of the highwages occupations (>95% percentile)
highWages_all<- wages %>%
            drop_na() %>%
            filter(as.numeric(annual)>quantile(as.numeric(annual), prob=c(.95))) 

#save only the occupation names
text <- highWages_all$occupation

#to form a corpus of the occupation names
docs_all <- Corpus(VectorSource(text))

## do the cleaning in the corpus


docs_all <- docs_all %>%
  tm_map(removeNumbers) %>% #remove numbers
  tm_map(removePunctuation) %>% #remove punctuation
  tm_map(stripWhitespace) #strip white spaces

# convert to lower case
docs_all <- tm_map(docs_all, content_transformer(tolower)) 
#remove some nonsense word like "the", "and"
docs_all <- tm_map(docs_all, removeWords, stopwords("english")) 


#convert the corpus as matrix and sort all of the words according to the frequency
dtm_all <- TermDocumentMatrix(docs_all) 
matrix_all <- as.matrix(dtm_all) 
words_all <- sort(rowSums(matrix_all),decreasing=TRUE) 

#convert the matrix to dataframe and indicate the frequency of the words
df_all <- data.frame(word = names(words_all),freq=words_all)

#filter out some words that have no specific meanings
df_all <- df_all %>%
  filter(word != "managers" & word != "general" &  word != "except" & word != "occupations" & word != "firstline" & word != "personal")

set.seed(12) # for reproducibility 

#create the wordcloud with the dataframe of words
my_graph=wordcloud2(data=df_all, size=0.5, color='random-dark')

#save it to image
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/total.png", delay = 5, vwidth = 500, vheight = 500)


```




In general, the occupations with salaries higher than the 95th percentile in these cities are more related with physicians, computer science and financial services.




```{r}

#define a function to create the wordcloud image of a specified city
word_cloud_HighWages <- function(a) { # input a is a string of city name
  
#select out all of the highwages occupations (>95% percentile) in the city specified
highWages<- wages %>%
            drop_na() %>%
            filter(city == a & as.numeric(annual)>quantile(as.numeric(annual), prob=c(.95))) 

#save only the occupation names
text <- highWages$occupation

#to form a corpus of the occupation names
docs <- Corpus(VectorSource(text))

## do the cleaning in the corpus

#remove punctuation
docs <- docs %>%
        tm_map(removePunctuation)

#transform to the lower case
docs <- tm_map(docs, content_transformer(tolower))

#remove some nonsense word like "the", "and"
docs <- tm_map(docs, removeWords, stopwords("english"))

#convert the corpus as matrix and sort all of the words according to the frequency
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 

#convert the matrix to dataframe and indicate the frequency of the words
df <- data.frame(word = names(words),freq=words)

#filter out some words that have no specific meanings
df <- df %>%
  filter(word != "managers" & word != "general" &  word != "except" & word != "occupations" & word != "firstline")

set.seed(12) # for reproducibility 

#create the wordcloud with the dataframe of words
wordcloud2(data=df, size=0.5, color='random-dark')
}

```




```{r}
my_graph = word_cloud_HighWages("Boston")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/boston.png", delay = 5, vwidth = 500, vheight = 500)
```


```{r}
my_graph=word_cloud_HighWages("San Jose")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/San Jose.png", delay = 5, vwidth = 500, vheight = 500)
```

```{r}
my_graph=word_cloud_HighWages("San Francisco")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/San Francisco.png", delay = 5, vwidth = 500, vheight = 500)

```
```{r}
my_graph=word_cloud_HighWages("San Diego")

saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/San Diego.png", delay = 5, vwidth = 500, vheight = 500)

```


```{r}
my_graph=word_cloud_HighWages("New York")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/New York.png", delay = 5, vwidth = 500, vheight = 500)

```

```{r}
my_graph=word_cloud_HighWages("Los Angeles")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/Los Angeles.png", delay = 5, vwidth = 500, vheight = 500)

```

```{r}
my_graph=word_cloud_HighWages("Chicago")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/Chicago.png", delay = 5, vwidth = 500, vheight = 500)
```
```{r}

my_graph=word_cloud_HighWages("Kansas City")
saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/Kansas City.png", delay = 5, vwidth = 500, vheight = 500)
```
```{r}
my_graph=word_cloud_HighWages("Raleigh")

saveWidget(my_graph, "tmp.html", selfcontained = F)
webshot("tmp.html", "wordcloud/Raleigh.png", delay = 5, vwidth = 500, vheight = 500)
```



According to these word cloud of high-paying jobs in different cities, it is obvious that cities in different areas has different features.

In the north east of USA, New York has more high-paying jobs related to financial services while in Boston high salaries are more correlated with medicine. 
San Diego has a similar distribution of high-paying jobs with Boston, both of which have a great emphasis on the health-care industry.

In the Bay area, we can see that there are more high-paying jobs in the computer science industry. For example, in the word cloud of San Francisco and San Jose, the word "computer" and "engineer" appears the most frequently.

In Raleigh, which is largest city of the Research Triangle metro area, high-paying jobs are more related with physicians and medicine.

In Chicago, which is the most populous city in the Midwestern United States, high-paying jobs are more related with the medicine industry and the financial industry.

When it comes to Kansas City, which is one of ten regional office cities for the US government, the word "Judges" appears the most frequently in the list of high-paying jobs. 



